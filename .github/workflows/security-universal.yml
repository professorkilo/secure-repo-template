name: Universal Security Scanning

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: read
  security-events: write
  actions: read

jobs:
  secret-scanning:
    name: Secret Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks Scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: TruffleHog Scan
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD

  file-security:
    name: File Security Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for suspicious files
        run: |
          echo "Checking for credentials files..."
          find . -type f \(             -name "*.pem" -o             -name "*.key" -o             -name "*.p12" -o             -name "*.pfx" -o             -name "credentials.json" -o             -name "secrets.json" -o             -name ".env"           \) -not -path "*/node_modules/*" -not -path "*/.git/*" 2>/dev/null | while read file; do
            echo "Found potentially sensitive file: $file"
            exit 1
          done || true
          echo "No suspicious credential files found"

  dependency-audit:
    name: Dependency Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for Python dependencies
        if: hashFiles('requirements.txt') != ''
        run: |
          python -m pip install --upgrade pip pip-audit
          pip-audit -r requirements.txt || true

      - name: Check for Node.js dependencies
        if: hashFiles('package.json') != ''
        run: |
          npm audit --audit-level=moderate || true